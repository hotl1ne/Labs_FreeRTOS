# –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞ —Ä–æ–±–æ—Ç–∞ ‚Ññ2: FreeRTOS Thread Local Storage (TLS)

–¶–µ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π –º—ñ—Å—Ç–∏—Ç—å —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—é –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ ‚Ññ2 –∑ –¥–∏—Å—Ü–∏–ø–ª—ñ–Ω–∏ "–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —á–∞—Å—É". –ü—Ä–æ—î–∫—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –º–µ—Ö–∞–Ω—ñ–∑–º—É **Thread Local Storage (TLS)** —É FreeRTOS –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Ç–æ–∫–æ–±–µ–∑–ø–µ—á–Ω–∏—Ö –∑–∞–¥–∞—á –±–µ–∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≥–ª–æ–±–∞–ª—å–Ω–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö.

## üìã –ú–µ—Ç–∞ —Ä–æ–±–æ—Ç–∏
[cite_start]–ù–∞–≤—á–∏—Ç–∏—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ TLS-—Å–ª–æ—Ç–∏ (`vTaskSetThreadLocalStoragePointer`, `pvTaskGetThreadLocalStoragePointer`) –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞–Ω—É –∑–∞–¥–∞—á—ñ —Ç–∞ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ thread-safe –º–æ–¥—É–ª—ñ[cite: 3, 4].

## üî¢ –í–∞—Ä—ñ–∞–Ω—Ç –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

**–ù–æ–º–µ—Ä –≤–∞—Ä—ñ–∞–Ω—Ç—É (IDX): 4**

[cite_start]–ó–≥—ñ–¥–Ω–æ –∑ –≤–∞—Ä—ñ–∞–Ω—Ç–æ–º —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –Ω–∞—Å—Ç—É–ø–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏[cite: 44]:

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–Ω—è | –û–ø–∏—Å |
| :--- | :--- | :--- |
| **–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–¥–∞—á (Ntasks)** | 4 | –ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ—Ç–æ–∫—ñ–≤, —â–æ —Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è |
| **–†–µ–∂–∏–º (Mode)** | `Delay` | –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è `vTaskDelay` –∑–∞–º—ñ—Å—Ç—å busy loop |
| **Burst Size (B)** | 4 | –ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä—è–¥–∫—ñ–≤ –ª–æ–≥—É, —â–æ –±—É—Ñ–µ—Ä–∏–∑—É—é—Ç—å—Å—è –ø–µ—Ä–µ–¥ –≤–∏–≤–æ–¥–æ–º |
| **TLS Index V1** | 0 | –Ü–Ω–¥–µ–∫—Å —Å–ª–æ—Ç–∞ –¥–ª—è `TaskContext` |
| **TLS Index V2** | 1 | –Ü–Ω–¥–µ–∫—Å —Å–ª–æ—Ç–∞ –¥–ª—è `Profile` |
| **–ë–∞–∑–æ–≤–∞ –∑–∞—Ç—Ä–∏–º–∫–∞** | 130 ms | –ë–∞–∑–æ–≤–∏–π —á–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è (–∑–º—ñ–Ω—é—î—Ç—å—Å—è –¥–ª—è –∫–æ–∂–Ω–æ—ó –∑–∞–¥–∞—á—ñ) |

## üõ†Ô∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –ó–∞–ø—É—Å–∫

### –í–∏–º–æ–≥–∏
* **IDE:** Visual Studio (MSVC)
* **FreeRTOS Kernel:** V10.x.x (–ø–æ—Ä—Ç WIN32)

### –ü–æ–∫—Ä–æ–∫–æ–≤–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –∑–∞–ø—É—Å–∫—É

1.  **–ö–ª–æ–Ω—É–≤–∞–Ω–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é:**
    ```bash
    git clone <–ø–æ—Å–∏–ª–∞–Ω–Ω—è_–Ω–∞_—Ü–µ–π_—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π>
    ```
2.  **–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è FreeRTOSConfig.h:**
    –î–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ TLS –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è, —â–æ —É —Ñ–∞–π–ª—ñ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –¥–æ–∑–≤–æ–ª–µ–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –º—ñ–Ω—ñ–º—É–º 2-—Ö —Å–ª–æ—Ç—ñ–≤ TLS.
    –£ —Ñ–∞–π–ª—ñ `FreeRTOSConfig.h`:
    ```c
    #define configNUM_THREAD_LOCAL_STORAGE_POINTERS 5
    ```
3.  **–ö–æ–º–ø—ñ–ª—è—Ü—ñ—è:**
    * –í—ñ–¥–∫—Ä–∏–π—Ç–µ —Ñ–∞–π–ª —Ä—ñ—à–µ–Ω–Ω—è `.sln` —É Visual Studio.
    * –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å `Build` -> `Rebuild Solution`.
4.  **–ó–∞–ø—É—Å–∫:**
    * –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å `F5` (Start Debugging).
    * –£ –∫–æ–Ω—Å–æ–ª—ñ –∑'—è–≤–∏—Ç—å—Å—è –≤–∏–≤—ñ–¥ —Ä–æ–±–æ—Ç–∏ –∑–∞–¥–∞—á.

## ‚öôÔ∏è –û–ø–∏—Å —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó

### –°—Ç—Ä—É–∫—Ç—É—Ä–∏ –¥–∞–Ω–∏—Ö
[cite_start]–ó–∞–º—ñ—Å—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö, –∫–æ–∂–Ω–∞ –∑–∞–¥–∞—á–∞ –≤–∏–¥—ñ–ª—è—î –ø–∞–º'—è—Ç—å —É –∫—É—á—ñ (Heap) –ø—ñ–¥ –¥–≤—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏, –≤–∫–∞–∑—ñ–≤–Ω–∏–∫–∏ –Ω–∞ —è–∫—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —É TLS[cite: 6, 28]:

1.  **`task_context_t` (–°–ª–æ—Ç 0):** –ó–±–µ—Ä—ñ–≥–∞—î —ñ–º'—è –∑–∞–¥–∞—á—ñ, –ª—ñ—á–∏–ª—å–Ω–∏–∫ —ñ—Ç–µ—Ä–∞—Ü—ñ–π, –ø–æ—Ç–æ—á–Ω—É –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É —Å—É–º—É (Checksum) —Ç–∞ –±—É—Ñ–µ—Ä –¥–ª—è –ª–æ–≥—ñ–≤ (Burst buffer).
2.  **`profile_t` (–°–ª–æ—Ç 1):** –ó–±–µ—Ä—ñ–≥–∞—î –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ä–µ–∂–∏–º—É —Ä–æ–±–æ—Ç–∏ (`MODE_DELAY`) —Ç–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ —á–∞—Å—É.

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–æ–±–æ—Ç–∏ –∑–∞–¥–∞—á—ñ (`vWorker`)

1.  **–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è:**
    * –ó–∞–¥–∞—á–∞ –æ—Ç—Ä–∏–º—É—î —Å–≤—ñ–π –Ω–æ–º–µ—Ä —á–µ—Ä–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç `pvParameters`.
    * –î–∏–Ω–∞–º—ñ—á–Ω–æ –≤–∏–¥—ñ–ª—è—î –ø–∞–º'—è—Ç—å (`pvPortMalloc`) –ø—ñ–¥ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç–∞ –ø—Ä–æ—Ñ—ñ–ª—å.
    * [cite_start]–ó–±–µ—Ä—ñ–≥–∞—î –≤–∫–∞–∑—ñ–≤–Ω–∏–∫–∏ —É TLS –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `vTaskSetThreadLocalStoragePointer`[cite: 52].

2.  **–û—Å–Ω–æ–≤–Ω–∏–π —Ü–∏–∫–ª:**
    * [cite_start]–ö—ñ–ª—å–∫—ñ—Å—Ç—å —ñ—Ç–µ—Ä–∞—Ü—ñ–π —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è –∑–∞ —Ñ–æ—Ä–º—É–ª–æ—é: $N_i = 10 \times N_{tasks} + IDX$[cite: 55].
    * –ù–∞ –∫–æ–∂–Ω—ñ–π —ñ—Ç–µ—Ä–∞—Ü—ñ—ó:
        * –û–Ω–æ–≤–ª—é—î—Ç—å—Å—è –ª—ñ—á–∏–ª—å–Ω–∏–∫ `iter`.
        * [cite_start]–†–æ–∑—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞ —Å—É–º–∞ **CRC8 (SAE J1850)** –Ω–∞ –æ—Å–Ω–æ–≤—ñ –Ω–æ–º–µ—Ä–∞ —ñ—Ç–µ—Ä–∞—Ü—ñ—ó —Ç–∞ `seed`[cite: 57].
        * –§–æ—Ä–º—É—î—Ç—å—Å—è —Ä—è–¥–æ–∫ –ª–æ–≥—É.
        * **Burst Mode:** –†—è–¥–æ–∫ –Ω–µ –≤–∏–≤–æ–¥–∏—Ç—å—Å—è –æ–¥—Ä–∞–∑—É, –∞ –∑–∞–ø–∏—Å—É—î—Ç—å—Å—è —É –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π –±—É—Ñ–µ—Ä. [cite_start]–í–∏–≤—ñ–¥ —É –∫–æ–Ω—Å–æ–ª—å (`printf`) –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –ª–∏—à–µ –∫–æ–ª–∏ –Ω–∞–∫–æ–ø–∏—á–µ–Ω–æ **4 —Ä—è–¥–∫–∏** (–∑–≥—ñ–¥–Ω–æ –∑ –≤–∞—Ä—ñ–∞–Ω—Ç–æ–º)[cite: 59].
        * [cite_start]–í–∏–∫–æ–Ω—É—î—Ç—å—Å—è –∑–∞—Ç—Ä–∏–º–∫–∞ `vTaskDelay` —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—é $130 + 7 \times i$ –º—Å[cite: 64].

3.  **–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è:**
    * –í–∏–≤–æ–¥—è—Ç—å—Å—è –∑–∞–ª–∏—à–∫–∏ –ª–æ–≥—ñ–≤ –∑ –±—É—Ñ–µ—Ä–∞ (`burst_flush`).
    * –ó–≤—ñ–ª—å–Ω—è—î—Ç—å—Å—è –ø–∞–º'—è—Ç—å (`vPortFree`).
    * [cite_start]–ó–∞–¥–∞—á–∞ –≤–∏–¥–∞–ª—è—î—Ç—å—Å—è (`vTaskDelete`)[cite: 71, 72].

## üì∏ –û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–£ –∫–æ–Ω—Å–æ–ª—ñ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏–º–µ—Ç—å—Å—è –ø–∞–∫–µ—Ç–Ω–∏–π –≤–∏–≤—ñ–¥ –ª–æ–≥—ñ–≤ –≤—ñ–¥ 4-—Ö –∑–∞–¥–∞—á:

```text
[Task_0] Tick: 130 Iter: 1 Sum: 0x3D
[Task_0] Tick: 260 Iter: 2 Sum: 0xA2
...
Task finished 0
